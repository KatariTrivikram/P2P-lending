<!DOCTYPE html>
<html>
<head>
  <title>Document-Based P2P Lending DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
      padding: 40px;
    }

    h2 {
      color: #1f2937;
      border-bottom: 2px solid #9ca3af;
      padding-bottom: 10px;
    }

    .section {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input, button {
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    #status {
      margin-top: 20px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>

  <h2>Lender Section</h2>
  <div class="section">
    <input type="number" id="interestRate" placeholder="Interest Rate (%) per month" />
    <input type="file" id="docUploadLender" />
    <button onclick="uploadAndOfferLoan()">Offer Loan</button>
  </div>

  <h2>Borrower Section</h2>
  <div class="section">
    <input type="file" id="docUploadBorrower" />
    <button onclick="uploadAndSubmitDoc()">Submit Document</button>
    <button onclick="takeLoan()">Take Loan</button>
    <button onclick="repayLoan()">Repay Loan</button>
  </div>

  <div id="status"></div>

  <script>
    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanStartTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    let web3;
    let contract;

    async function initWeb3() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        contract = new web3.eth.Contract(contractABI, contractAddress);
      } else {
        alert("Please install MetaMask to use this DApp.");
      }
    }

    async function hashFile(file) {
      const buffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return '0x' + hashHex;
    }

    async function uploadAndOfferLoan() {
      const fileInput = document.getElementById("docUploadLender");
      const interestRate = document.getElementById("interestRate").value;

      if (fileInput.files.length === 0 || !interestRate) {
        alert("Please upload a document and enter interest rate.");
        return;
      }

      const file = fileInput.files[0];
      const hash = await hashFile(file);

      const accounts = await web3.eth.getAccounts();
      const loanAmount = web3.utils.toWei("0.01", "ether");

      try {
        await contract.methods.offerLoan(interestRate, hash).send({
          from: accounts[0],
          value: loanAmount
        });
        document.getElementById("status").innerText = "Loan offered successfully.";
      } catch (e) {
        document.getElementById("status").innerText = "Failed to offer loan.";
      }
    }

    async function uploadAndSubmitDoc() {
      const fileInput = document.getElementById("docUploadBorrower");

      if (fileInput.files.length === 0) {
        alert("Please upload your document.");
        return;
      }

      const file = fileInput.files[0];
      const hash = await hashFile(file);

      const accounts = await web3.eth.getAccounts();

      try {
        await contract.methods.submitDocument(hash).send({ from: accounts[0] });
        document.getElementById("status").innerText = "Document submitted successfully.";
      } catch (e) {
        document.getElementById("status").innerText = "Failed to submit document.";
      }
    }

    async function takeLoan() {
      const accounts = await web3.eth.getAccounts();
      try {
        await contract.methods.takeLoan().send({ from: accounts[0] });
        document.getElementById("status").innerText = "Loan taken successfully.";
      } catch (e) {
        document.getElementById("status").innerText = "Failed to take loan.";
      }
    }

    // âœ… UPDATED REPAY FUNCTION (Auto Calculate + Send)
    async function repayLoan() {
      try {
        const accounts = await web3.eth.getAccounts();
        const borrowerAddress = await contract.methods.borrower().call();

        if (accounts[0].toLowerCase() !== borrowerAddress.toLowerCase()) {
          document.getElementById("status").innerText = "Only borrower can repay the loan.";
          return;
        }

        const loanAmount = BigInt(await contract.methods.loanAmount().call());
        const interestRate = BigInt(await contract.methods.interestRate().call());
        const loanStartTime = BigInt(await contract.methods.loanStartTime().call());

        const now = BigInt(Math.floor(Date.now() / 1000));
        const monthsElapsed = (now - loanStartTime) / BigInt(30 * 24 * 60 * 60);
        const interest = (loanAmount * interestRate * (monthsElapsed + BigInt(1))) / BigInt(100);
        const totalDue = loanAmount + interest;

        await contract.methods.repayLoan().send({
          from: accounts[0],
          value: totalDue.toString()
        });

        document.getElementById("status").innerText = "Loan repaid successfully!";
      } catch (error) {
        console.error("Repayment failed:", error);
        document.getElementById("status").innerText = "Failed to repay loan.";
      }
    }

    window.onload = initWeb3;
  </script>
</body>
</html>
