<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document-backed P2P Lending</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      color: #333;
      padding: 30px;
    }
    h2 {
      color: #222;
    }
    .section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 30px;
    }
    input, button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 8px;
      display: block;
      width: 100%;
    }
    button {
      background: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <h2>Document-based Decentralized Lending Platform</h2>

  <div class="section" id="lender">
    <h3>Lender Section</h3>
    <input type="number" id="loanAmount" placeholder="Loan Amount (ETH)" />
    <input type="number" id="interestRate" placeholder="Interest Rate (%)" />
    <input type="file" id="docUploadLender" />
    <button onclick="offerLoan()">Offer Loan</button>
  </div>

  <div class="section" id="borrower">
    <h3>Borrower Section</h3>
    <input type="text" id="phoneNumber" placeholder="Enter phone number" />
    <button onclick="sendOTP()">Send OTP</button>
    <input type="text" id="otp" placeholder="Enter OTP" />
    <button onclick="verifyOTP()">Verify OTP</button>

    <input type="file" id="docUploadBorrower" />
    <button onclick="submitDocument()">Submit Document</button>
    <button onclick="takeLoan()">Take Loan</button>
    <button onclick="repayLoan()">Repay Loan</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7E27dTzpP48muPwSt-hVSNvPai5SHryU",
      authDomain: "p2plending-c864a.firebaseapp.com",
      projectId: "p2plending-c864a",
      storageBucket: "p2plending-c864a.appspot.com",
      messagingSenderId: "916198463762",
      appId: "1:916198463762:web:de2cf6383ff18d456dbbcb",
      measurementId: "G-SHSBBCS0W7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'phoneNumber', {
      'size': 'invisible',
      'callback': () => {}
    });

    let contract;
    let userAccount;
    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanStartTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    window.onload = async () => {
      if (window.ethereum) {
        const web3 = new Web3(window.ethereum);
        await window.ethereum.enable();
        const accounts = await web3.eth.getAccounts();
        userAccount = accounts[0];
        contract = new web3.eth.Contract(contractABI, contractAddress);
      } else {
        alert("MetaMask not found");
      }
    };

    window.sendOTP = async () => {
      const phoneNumber = document.getElementById("phoneNumber").value;
      signInWithPhoneNumber(auth, "+91" + phoneNumber, window.recaptchaVerifier)
        .then(confirmationResult => {
          window.confirmationResult = confirmationResult;
          alert("OTP sent");
        }).catch(error => {
          console.error(error);
        });
    };

    window.verifyOTP = async () => {
      const otp = document.getElementById("otp").value;
      confirmationResult.confirm(otp).then(() => {
        alert("Phone verified");
      }).catch(error => {
        alert("OTP failed");
      });
    };

    async function hashFile(file) {
      const arrayBuffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    window.offerLoan = async () => {
      const file = document.getElementById("docUploadLender").files[0];
      if (!file || !contract) return alert("Upload document");
      const docHash = await hashFile(file);
      const amount = Web3.utils.toWei(document.getElementById("loanAmount").value, "ether");
      const interest = document.getElementById("interestRate").value;

      try {
        const tx = await contract.methods.offerLoan(interest, docHash).send({ from: userAccount, value: amount });
        alert("Loan offered successfully");
      } catch (err) {
        alert("Offer Loan failed");
      }
    };

    window.submitDocument = async () => {
      const file = document.getElementById("docUploadBorrower").files[0];
      const phone = document.getElementById("phoneNumber").value;
      if (!file || !phone) return alert("Upload document and enter phone");
      const docHash = await hashFile(file);

      try {
        const tx = await contract.methods.submitDocument(docHash, phone).send({ from: userAccount });
        alert("Document submitted");
      } catch (err) {
        alert("Failed to submit document");
      }
    };

    window.takeLoan = async () => {
      try {
        const tx = await contract.methods.takeLoan().send({ from: userAccount });
        alert("Loan taken");
      } catch (err) {
        alert("Loan failed");
      }
    };

    window.repayLoan = async () => {
      try {
        const loanAmount = await contract.methods.loanAmount().call();
        const interestRate = await contract.methods.interestRate().call();
        const interest = loanAmount * interestRate / 100;
        const totalRepay = BigInt(loanAmount) + BigInt(interest);

        const tx = await contract.methods.repayLoan().send({ from: userAccount, value: totalRepay.toString() });
        alert("Loan repaid");
      } catch (err) {
        alert("Repayment failed");
      }
    };
  </script>
</body>
</html>
