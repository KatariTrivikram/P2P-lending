<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Document-Backed Lending DApp</title>
Â  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">


Â  <style>
Â  Â  :root {
Â  Â  Â  --bg-light: #f3f4f6;
Â  Â  Â  --bg-dark: #121212;
Â  Â  Â  --text-light: #1f2937;
Â  Â  Â  --text-dark: #f9fafb;
Â  Â  }

Â  Â  body {
Â  Â  Â  background: linear-gradient(to right, #e0f7fa, #ede7f6);
Â  Â  Â  transition: all 0.4s ease-in-out;
Â  Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  }

Â  Â  body.dark-mode {
Â  Â  Â  background: linear-gradient(to right, #121212, #1f1f1f);
Â  Â  Â  color: var(--text-dark);
Â  Â  }

Â  Â  .container {
Â  Â  Â  background: rgba(255, 255, 255, 0.85);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
Â  Â  Â  transition: 0.4s;
Â  Â  }

Â  Â  body.dark-mode .container {
Â  Â  Â  background: rgba(33, 33, 33, 0.85);
Â  Â  Â  color: var(--text-dark);
Â  Â  }

Â  Â  .title {
Â  Â  Â  font-size: 2.7rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  text-align: center;
Â  Â  Â  background: linear-gradient(to right, #8e44ad, #3498db);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  }

Â  Â  .lender-panel {
Â  Â  Â  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 1rem;
Â  Â  }

Â  Â  .borrower-panel {
Â  Â  Â  background: linear-gradient(135deg, #f3e5f5, #ce93d8);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 1rem;
Â  Â  }

Â  Â  .card {
Â  Â  Â  border-radius: 20px;
Â  Â  Â  backdrop-filter: blur(8px);
Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
Â  Â  Â  transition: 0.3s ease-in-out;
Â  Â  }

Â  Â  .card:hover {
Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
Â  Â  }

Â  Â  .form-control {
Â  Â  Â  border-radius: 12px;
Â  Â  }

Â  Â  .btn {
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  transition: 0.3s;
Â  Â  }

Â  Â  .btn-success { background: linear-gradient(to right, #10b981, #34d399); color: white; border: none; }
Â  Â  .btn-warning { background: linear-gradient(to right, #f59e0b, #fbbf24); color: white; border: none; }
Â  Â  .btn-primary { background: linear-gradient(to right, #3b82f6, #60a5fa); color: white; border: none; }
Â  Â  .btn-purpleÂ  { background: linear-gradient(to right, #8b5cf6, #a78bfa); color: white; border: none; }
Â  Â  .btn-resetÂ  Â { background: linear-gradient(to right, #14b8a6, #2dd4bf); color: white; border: none; }

Â  Â  #repayStatus {
Â  Â  Â  font-weight: bold;
Â  Â  }

Â  Â  .dark-toggle {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 1rem;
Â  Â  Â  right: 1rem;
Â  Â  Â  z-index: 999;
Â  Â  }

Â  Â  /* Toast styles */
Â  Â  #toastBox {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 20px;
Â  Â  Â  right: 20px;
Â  Â  Â  z-index: 9999;
Â  Â  }

Â  Â  .toast {
Â  Â  Â  background-color: #0d6efd;
Â  Â  Â  color: white;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  animation: slideIn 0.5s ease-out;
Â  Â  }

Â  Â  @keyframes slideIn {
Â  Â  Â  from { opacity: 0; transform: translateX(100px); }
Â  Â  Â  to { opacity: 1; transform: translateX(0); }
Â  Â  }
Â  </style>
</head>
<body>
Â  <button class="btn btn-dark dark-toggle" onclick="toggleDarkMode()">ğŸŒ“ Toggle Dark Mode</button>

Â  <div class="container py-5 px-4">
Â  Â  <h2 class="title mb-4">ğŸ“œ Document-Backed Lending DApp</h2>

Â  Â  <lottie-player
Â  Â  Â  src="https://assets5.lottiefiles.com/packages/lf20_ydo1amjm.json"
Â  Â  Â  background="transparent"
Â  Â  Â  speed="1"
Â  Â  Â  style="width: 100px; height: 100px; margin: 0 auto;"
Â  Â  Â  loop
Â  Â  Â  autoplay>
Â  Â  </lottie-player>

Â  Â  <div class="text-end mb-3">
Â  Â  Â  <button onclick="resetLoanManually()" class="btn btn-reset btn-sm">ğŸ” Reset Loan (Lender Only)</button>
Â  Â  </div>

Â  Â  <div class="card mb-4 p-4">
Â  Â  Â  <h5>ğŸ”Œ Wallet Connection</h5>
Â  Â  Â  <button class="btn btn-primary mb-2" onclick="connectWallet()">Connect Wallet</button>
Â  Â  Â  <p id="walletAddress" class="text-success"></p>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="col-md-6 mb-4">
Â  Â  Â  Â  <div class="lender-panel h-100">
Â  Â  Â  Â  Â  <div class="card p-4">
Â  Â  Â  Â  Â  Â  <h5>ğŸ’° Lender Panel</h5>
Â  Â  Â  Â  Â  Â  <input id="interestRate" class="form-control mb-2" placeholder="Interest Rate (%)">
Â  Â  Â  Â  Â  Â  <input id="loanAmount" class="form-control mb-2" placeholder="Loan Amount (in ETH)">
Â  Â  Â  Â  Â  Â  <input type="file" id="lenderDoc" class="form-control mb-3">
Â  Â  Â  Â  Â  Â  <button class="btn btn-success w-100" onclick="offerLoan()">Offer Loan</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="col-md-6 mb-4">
Â  Â  Â  Â  <div class="borrower-panel h-100">
Â  Â  Â  Â  Â  <div class="card p-4">
Â  Â  Â  Â  Â  Â  <h5>ğŸ“„ Borrower Panel</h5>
Â  Â  Â  Â  Â  Â  <input type="file" id="borrowerDoc" class="form-control mb-3">
Â  Â  Â  Â  Â  Â  <button class="btn btn-warning w-100 mb-2" onclick="submitDocument()">Submit Document</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary w-100 mb-2" onclick="takeLoan()">Take Loan</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-purple w-100 mb-2" onclick="repayLoan()">Repay Loan</button>
Â  Â  Â  Â  Â  Â  <p id="repayStatus" class="mt-3 text-danger"></p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="toastBox"></div>

Â  <script>
Â  Â  // Toggle Dark Mode
Â  Â  function toggleDarkMode() {
Â  Â  Â  document.body.classList.toggle("dark-mode");
Â  Â  }

Â  Â  // Toast Notification
Â  Â  function showToast(message, type = "info") {
Â  Â  Â  const toast = document.createElement("div");
Â  Â  Â  toast.className = "toast";
Â  Â  Â  toast.innerText = message;

Â  Â  Â  if (type === "error") toast.style.backgroundColor = "#dc3545";
Â  Â  Â  if (type === "success") toast.style.backgroundColor = "#28a745";

Â  Â  Â  document.getElementById("toastBox").appendChild(toast);
Â  Â  Â  setTimeout(() => toast.remove(), 3000);
Â  Â  }

let web3;
let account;
const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";
const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanStartTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

let contract;

async function connectWallet() {
    if (window.ethereum) {
        try {
            // Request accounts and initialize web3 provider
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            web3 = new Web3(window.ethereum);
            account = accounts[0];
            document.getElementById("walletAddress").innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
            contract = new web3.eth.Contract(contractABI, contractAddress);
            showToast("Wallet connected!", "success");

            // Optional: Listen for account changes
            window.ethereum.on('accountsChanged', function (newAccounts) {
                if (newAccounts.length === 0) {
                    document.getElementById("walletAddress").innerText = 'No account connected.';
                    showToast("Wallet disconnected.", "info");
                    account = null;
                } else {
                    account = newAccounts[0];
                    document.getElementById("walletAddress").innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
                    showToast("Account changed.", "info");
                }
            });

        } catch (error) {
            if (error.code === 4001) {
                // User rejected connection
                showToast("Wallet connection rejected by user.", "error");
            } else {
                console.error(error);
                showToast("Failed to connect wallet.", "error");
            }
        }
    } else {
        showToast("Please install MetaMask or a compatible wallet extension.", "error");
    }
}

async function offerLoan() {
Â  const rate = document.getElementById("interestRate").value;
Â  const amount = document.getElementById("loanAmount").value;
Â  const file = document.getElementById("lenderDoc").files[0];
Â  if (!file) {
    showToast("Please upload a document", "error");
    return;
  }
  if (!web3 || !account) {
    showToast("Please connect your wallet first.", "error");
    return;
  }
Â  const hash = await getFileHash(file);
Â  try {
Â  Â  await contract.methods.offerLoan(rate, hash).send({ from: account, value: web3.utils.toWei(amount, 'ether') });
Â  Â  showToast("Loan offered successfully.", "success");
Â  } catch (err) {
Â  Â  console.error(err);
Â  Â  showToast("Failed to offer loan. Make sure the loan is reset and try again.", "error");
Â  }
}

async function submitDocument() {
Â  const file = document.getElementById("borrowerDoc").files[0];
Â  if (!file) {
    showToast("Please upload a document", "error");
    return;
  }
  if (!web3 || !account) {
    showToast("Please connect your wallet first.", "error");
    return;
  }
Â  const hash = await getFileHash(file);
Â  try {
    await contract.methods.submitDocument(hash).send({ from: account });
    showToast("Document submitted successfully!", "success");
  } catch(err) {
    console.error(err);
    showToast("Failed to submit document.", "error");
  }
}

async function takeLoan() {
Â  if (!web3 || !account) {
    showToast("Please connect your wallet first.", "error");
    return;
  }
  try {
Â    await contract.methods.takeLoan().send({ from: account });
    showToast("Loan taken successfully!", "success");
  } catch(err) {
    console.error(err);
    showToast("Failed to take loan.", "error");
  }
}

async function repayLoan() {
Â  if (!web3 || !account) {
    showToast("Please connect your wallet first.", "error");
    return;
  }
  try {
Â  Â  const [loanAmount, interestRate, loanStartTime, lenderAddress] = await Promise.all([
Â  Â  Â  contract.methods.loanAmount().call(),
Â  Â  Â  contract.methods.interestRate().call(),
Â  Â  Â  contract.methods.loanStartTime().call(),
Â  Â  Â  contract.methods.lender().call()
Â  Â  ]);

Â  Â  const now = Math.floor(Date.now() / 1000);
Â  Â  const elapsed = now - Number(loanStartTime);
Â  Â  const monthsElapsed = Math.floor(elapsed / (30 * 24 * 60 * 60));

Â  Â  const interest = (BigInt(loanAmount) * BigInt(interestRate) * BigInt(monthsElapsed + 1)) / 100n;
Â  Â  const totalDue = BigInt(loanAmount) + interest;

Â  Â  await contract.methods.repayLoan().send({ from: account, value: totalDue.toString() });

Â  Â  document.getElementById("repayStatus").innerText = "âœ… Repayment successful. Resetting loan...";
Â  Â  document.getElementById("repayStatus").classList.remove("text-danger");
Â  Â  document.getElementById("repayStatus").classList.add("text-success");
    showToast("Repayment successful!", "success");

Â  Â  // Try auto reset (only if lender)
Â  Â  if (account.toLowerCase() === lenderAddress.toLowerCase()) {
Â  Â  Â  try {
Â  Â  Â  Â  await contract.methods.resetLoan().send({ from: account });
Â  Â  Â  Â  document.getElementById("repayStatus").innerText = "âœ… Loan repaid and reset. You can now start a new one.";
      showToast("Loan reset successfully!", "success");
Â  Â  Â  } catch (resetError) {
Â  Â  Â  Â  console.error("Reset failed:", resetError);
Â  Â  Â  Â  document.getElementById("repayStatus").innerText = "Repayment done, but loan reset failed.";
      showToast("Repayment done, but loan reset failed.", "error");
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  document.getElementById("repayStatus").innerText = "âœ… Repayment done. Lender must reset to start a new loan.";
    showToast("Repayment done. Lender must reset.", "info");
Â  Â  }

Â  } catch (err) {
Â  Â  console.error("Repay failed:", err);
Â  Â  document.getElementById("repayStatus").innerText = "âŒ Failed to repay loan.";
    showToast("Failed to repay loan.", "error");
Â  }
}

async function resetLoanManually() {
Â  if (!web3 || !account) {
    showToast("Please connect your wallet first.", "error");
    return;
  }
  try {
Â  Â  await contract.methods.resetLoan().send({ from: account });
Â  Â  document.getElementById("repayStatus").innerText = "Loan reset manually by lender.";
Â  Â  document.getElementById("repayStatus").classList.remove("text-danger");
Â  Â  document.getElementById("repayStatus").classList.add("text-success");
    showToast("Loan reset successfully!", "success");
Â  } catch (err) {
Â  Â  console.error(err);
Â  Â  document.getElementById("repayStatus").innerText = "Manual reset failed.";
    showToast("Manual reset failed.", "error");
Â  }
}

async function getFileHash(file) {
Â  return new Promise((resolve, reject) => {
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = () => {
Â  Â  Â  const buffer = new Uint8Array(reader.result);
Â  Â  Â  const hashBuffer = new TextEncoder().encode(buffer);
Â  Â  Â  crypto.subtle.digest('SHA-256', hashBuffer).then(h => {
Â  Â  Â  Â  resolve("0x" + Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join(''));
Â  Â  Â  });
Â  Â  };
Â  Â  reader.onerror = reject;
Â  Â  reader.readAsArrayBuffer(file);
Â  });
}

Â  </script>
</body>
</html>
