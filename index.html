<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document-backed P2P Lending</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin: 12px 0 4px;
      font-weight: bold;
    }
    input[type="text"], input[type="file"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background-color: #007bff;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    .section {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Document-backed P2P Lending DApp</h1>

    <div class="section" id="walletSection">
      <button onclick="connectWallet()">Connect Wallet</button>
    </div>

    <!-- LENDER -->
    <div class="section">
      <h2>Lender Section</h2>
      <label for="loanAmount">Loan Amount (ETH):</label>
      <input type="number" id="loanAmount" />

      <label for="interestRate">Interest Rate (%):</label>
      <input type="number" id="interestRate" />

      <button onclick="offerLoan()">Offer Loan</button>

      <button onclick="repayLoan()" style="background-color: #28a745">Repay Loan</button>
    </div>

    <!-- BORROWER -->
    <div class="section">
      <h2>Borrower Section</h2>

      <label for="phone">Phone Number:</label>
      <input type="text" id="phone" placeholder="Enter phone number" />
      <button onclick="sendOTP()" style="background-color: #ffc107; color: black;">Send OTP</button>

      <label for="otp">OTP:</label>
      <input type="text" id="otp" placeholder="Enter OTP" />
      <button onclick="verifyOTP()" style="background-color: #28a745">Verify OTP</button>

      <label for="document">Upload Document:</label>
      <input type="file" id="document" />
      <button onclick="submitDocument()">Submit Document</button>

      <button onclick="takeLoan()" style="background-color: #17a2b8">Take Loan</button>
    </div>
  </div>

  <script>
    const contractAddress = "0x608578ad799148D5009D66800BA4EB3eD361943D";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "_phone",
				"type": "string"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "borrowerPhone",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
    let web3, contract, accounts;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          web3 = new Web3(window.ethereum);
          accounts = await web3.eth.getAccounts();
          contract = new web3.eth.Contract(contractABI, contractAddress);
          alert("Wallet connected: " + accounts[0]);
        } catch (error) {
          alert("Wallet connection failed.");
          console.error(error);
        }
      } else {
        alert("MetaMask not found");
      }
    }

    async function hashDocument(file) {
      const buffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
      const byteArray = new Uint8Array(hashBuffer);
      return "0x" + Array.from(byteArray).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function submitDocument() {
      const file = document.getElementById("document").files[0];
      const phone = document.getElementById("phone").value;
      if (!file || !phone) return alert("Upload document and phone first");

      const hash = await hashDocument(file);
      try {
        await contract.methods.submitDocument(hash, phone).send({ from: accounts[0] });
        alert("Document submitted with hash: " + hash);
      } catch (err) {
        alert("Submission failed");
        console.error(err);
      }
    }

    async function offerLoan() {
      const amount = document.getElementById("loanAmount").value;
      const rate = document.getElementById("interestRate").value;
      const docHash = await contract.methods.documentHash().call();
      try {
        await contract.methods.offerLoan(rate, docHash).send({ from: accounts[0], value: web3.utils.toWei(amount, 'ether') });
        alert("Loan Offered");
      } catch (err) {
        alert("Offer failed");
        console.error(err);
      }
    }

    async function takeLoan() {
      try {
        await contract.methods.takeLoan().send({ from: accounts[0] });
        alert("Loan Taken");
      } catch (err) {
        alert("Failed to take loan");
        console.error(err);
      }
    }

    async function repayLoan() {
      try {
        const loanAmount = await contract.methods.loanAmount().call();
        const interest = await contract.methods.interestRate().call();
        const totalRepayment = BigInt(loanAmount) + (BigInt(loanAmount) * BigInt(interest)) / 100n;
        await contract.methods.repayLoan().send({ from: accounts[0], value: totalRepayment.toString() });
        alert("Loan Repaid");
      } catch (err) {
        alert("Repayment failed");
        console.error(err);
      }
    }

    function sendOTP() {
      alert("OTP sent (simulate Firebase)");
    }
    function verifyOTP() {
      alert("OTP verified (simulate Firebase)");
    }
  </script>
</body>
</html>
