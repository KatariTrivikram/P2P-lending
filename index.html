<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Lending Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
  <h2>P2P Lending Platform</h2>
  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="wallet-address">Wallet: Not Connected</p>

  <!-- Document Submission Form -->
  <h3>Submit Document</h3>
  <input type="file" id="docFile" />
  <input type="text" id="phoneNumber" placeholder="Enter Phone Number" />
  <div id="recaptcha-container"></div>
  <button onclick="sendOTP()">Send OTP</button>
  <input type="text" id="otp" placeholder="Enter OTP" />
  <button onclick="verifyOTP()">Verify OTP & Submit</button>

  <script>
    let provider, signer, contract, userAddress;

    const contractAddress = "0x608578ad799148D5009D66800BA4EB3eD361943D";
    const abi = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "_phone",
				"type": "string"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "borrowerPhone",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    async function connectWallet() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          userAddress = accounts[0];
          document.getElementById("wallet-address").innerText = "Wallet: " + userAddress;
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, abi, signer);
          alert("Wallet connected successfully!");
        } catch (err) {
          console.error("User denied wallet connection", err);
          alert("Wallet connection failed: " + err.message);
        }
      } else {
        alert("MetaMask not detected. Please install MetaMask extension.");
      }
    }

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7E27dTzpP48muPwSt-hVSNvPai5SHryU",
      authDomain: "p2plending-c864a.firebaseapp.com",
      projectId: "p2plending-c864a",
      storageBucket: "p2plending-c864a.firebasestorage.app",
      messagingSenderId: "916198463762",
      appId: "1:916198463762:web:de2cf6383ff18d456dbbcb",
      measurementId: "G-SHSBBCS0W7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    function sendOTP() {
      const phoneNumber = document.getElementById("phoneNumber").value;
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container');
      auth.signInWithPhoneNumber("+91" + phoneNumber, appVerifier)
        .then(confirmationResult => {
          window.confirmationResult = confirmationResult;
          alert("OTP sent successfully!");
        }).catch(error => {
          alert("OTP send failed: " + error.message);
        });
    }

    async function verifyOTP() {
      const otp = document.getElementById("otp").value;
      const file = document.getElementById("docFile").files[0];
      const reader = new FileReader();
      reader.onload = async function(e) {
        const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(e.target.result));

        try {
          await window.confirmationResult.confirm(otp);
          const tx = await contract.submitDocument(hash, document.getElementById("phoneNumber").value);
          await tx.wait();
          alert("Document submitted successfully!");
        } catch (error) {
          console.error(error);
          alert("Submit failed: " + error.message);
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
