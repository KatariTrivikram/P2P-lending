<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document-Backed Loan DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-6 text-center text-indigo-700">ðŸ“„ Document-Backed Loan DApp</h1>

    <div id="account" class="mb-4 text-center text-gray-600">Connecting...</div>

    <div class="grid gap-4">
      <input id="docFile" type="file" class="p-2 border rounded w-full" />
      <button onclick="submitDocument()" class="bg-blue-500 text-white rounded p-2 hover:bg-blue-600">Submit Document</button>

      <button onclick="takeLoan()" class="bg-green-500 text-white rounded p-2 hover:bg-green-600">Take Loan</button>

      <button onclick="repayLoan()" class="bg-purple-500 text-white rounded p-2 hover:bg-purple-600">Repay Loan (Auto)</button>

      <div id="loanStatus" class="mt-4 text-gray-700"></div>
    </div>
  </div>

  <script>
    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc"; // Replace with deployed address
    const abi = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanStartTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // Replace with your contract ABI

    let web3;
    let contract;
    let userAccount;

    window.addEventListener('load', async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        userAccount = accounts[0];
        document.getElementById("account").innerText = `Connected: ${userAccount}`;

        contract = new web3.eth.Contract(abi, contractAddress);
        updateStatus();
      } else {
        alert("Please install MetaMask!");
      }
    });

    async function submitDocument() {
      const file = document.getElementById("docFile").files[0];
      if (!file) return alert("Please choose a file");

      const reader = new FileReader();
      reader.onload = async function () {
        const hash = web3.utils.sha3(reader.result);
        try {
          await contract.methods.submitDocument(hash).send({ from: userAccount });
          alert("Document submitted successfully");
          updateStatus();
        } catch (err) {
          alert("Failed to submit document: " + err.message);
        }
      };
      reader.readAsBinaryString(file);
    }

    async function takeLoan() {
      try {
        await contract.methods.takeLoan().send({ from: userAccount });
        alert("Loan taken successfully!");
        updateStatus();
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function repayLoan() {
      try {
        const loanAmount = await contract.methods.loanAmount().call();
        const interestRate = await contract.methods.interestRate().call();
        const start = await contract.methods.loanStartTime().call();

        const now = Math.floor(Date.now() / 1000);
        const monthsElapsed = Math.floor((now - start) / (30 * 24 * 60 * 60)) + 1;
        const interest = loanAmount * interestRate * monthsElapsed / 100;
        const totalDue = Math.floor(Number(loanAmount) + interest);

        await contract.methods.repayLoan().send({ from: userAccount, value: totalDue });
        alert(`Repayment of ${totalDue} wei successful`);
        updateStatus();
      } catch (err) {
        alert("Repayment failed: " + err.message);
      }
    }

    async function updateStatus() {
      try {
        const offered = await contract.methods.loanOffered().call();
        const taken = await contract.methods.loanTaken().call();
        const repaid = await contract.methods.loanRepaid().call();
        const doc = await contract.methods.docSubmitted().call();
        const loanAmt = await contract.methods.loanAmount().call();
        const interest = await contract.methods.interestRate().call();

        document.getElementById("loanStatus").innerHTML = `
          <p><strong>Loan Offered:</strong> ${offered}</p>
          <p><strong>Document Submitted:</strong> ${doc}</p>
          <p><strong>Loan Taken:</strong> ${taken}</p>
          <p><strong>Loan Repaid:</strong> ${repaid}</p>
          <p><strong>Loan Amount:</strong> ${loanAmt} wei</p>
          <p><strong>Interest Rate:</strong> ${interest}%</p>
        `;
      } catch (err) {
        console.log("Error fetching status", err);
      }
    }
  </script>
</body>
</html>
