<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document-Based P2P Lending Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
</head>
<body>
  <h2>Connect Wallet</h2>
  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletAddress"></p>

  <h2>Submit Document</h2>
  <input type="file" id="docFile" />
  <input type="text" id="phoneNumber" placeholder="Phone Number" />
  <button onclick="submitDocument()">Submit Document</button>

  <h2>Offer Loan</h2>
  <input type="text" id="loanAmount" placeholder="Loan Amount in ETH" />
  <input type="number" id="interestRate" placeholder="Interest Rate (%)" />
  <button onclick="offerLoan()">Offer Loan</button>

  <h2>Take Loan</h2>
  <button onclick="takeLoan()">Take Loan</button>

  <h2>Repay Loan</h2>
  <input type="text" id="repayAmount" placeholder="Repayment Amount in ETH" />
  <button onclick="repayLoan()">Repay Loan</button>

  <script>
    const contractAddress = "0x608578ad799148D5009D66800BA4EB3eD361943D";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "_phone",
				"type": "string"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "borrowerPhone",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
    let web3;
    let contract;

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        document.getElementById("walletAddress").innerText = `Connected: ${accounts[0]}`;
        contract = new web3.eth.Contract(contractABI, contractAddress);
      } else {
        alert("Please install MetaMask.");
      }
    }

    async function submitDocument() {
      const file = document.getElementById("docFile").files[0];
      const phone = document.getElementById("phoneNumber").value;
      if (!file || !phone) return alert("Upload file and enter phone number.");

      const reader = new FileReader();
      reader.onload = async function (e) {
        const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(e.target.result));
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = '0x' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        try {
          const accounts = await web3.eth.getAccounts();
          await contract.methods.submitDocument(hashHex, phone).send({ from: accounts[0] });
          alert("Document submitted.");
        } catch (err) {
          console.error(err);
          alert("Failed to submit document.");
        }
      };
      reader.readAsText(file);
    }

    async function offerLoan() {
      const interest = document.getElementById("interestRate").value;
      const amount = document.getElementById("loanAmount").value;

      try {
        const accounts = await web3.eth.getAccounts();
        const docHash = await contract.methods.documentHash().call();
        await contract.methods.offerLoan(interest, docHash).send({
          from: accounts[0],
          value: web3.utils.toWei(amount, "ether")
        });
        alert("Loan offered successfully!");
      } catch (err) {
        console.error(err);
        alert("Offer loan failed.");
      }
    }

    async function takeLoan() {
      try {
        const accounts = await web3.eth.getAccounts();
        await contract.methods.takeLoan().send({ from: accounts[0] });
        alert("Loan taken.");
      } catch (err) {
        console.error(err);
        alert("Take loan failed.");
      }
    }

    async function repayLoan() {
      const amount = document.getElementById("repayAmount").value;
      try {
        const accounts = await web3.eth.getAccounts();
        await contract.methods.repayLoan().send({
          from: accounts[0],
          value: web3.utils.toWei(amount, "ether")
        });
        alert("Loan repaid.");
      } catch (err) {
        console.error(err);
        alert("Repayment failed.");
      }
    }
  </script>
</body>
</html>
