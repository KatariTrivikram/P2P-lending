<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document-Backed Lending DApp</title>

  <!-- Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(to right, #e0f7fa, #ede7f6);
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 650px;
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    .dark-mode {
      background: #121212;
      color: #eee;
    }
    .panel {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease-in-out;
    }
    .panel.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .toast {
      padding: 10px;
      border-radius: 5px;
      color: white;
      margin-top: 5px;
    }
    #toastBox {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    .history-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
    }
    .history-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 70%;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h2 class="mb-4">ðŸ“„ Document-Backed Lending DApp</h2>

    <!-- Wallet -->
    <button class="btn btn-primary mb-3" onclick="connectWallet()">ðŸ”— Connect Wallet</button>
    <p id="walletAddress" class="fw-bold" style="display:none;">Not connected</p>

    <!-- Action buttons -->
    <div class="mb-3">
      <button id="lenderBtn" class="btn btn-outline-success action-btn" onclick="showPanel('lender')">I'm Lender</button>
      <button id="borrowerBtn" class="btn btn-outline-warning action-btn" onclick="showPanel('borrower')">I'm Borrower</button>
      <button class="btn btn-outline-dark" onclick="toggleDarkMode()">ðŸŒ™ Toggle Dark Mode</button>
      <button class="btn btn-outline-info" onclick="showHistoryModal()">ðŸ“œ History</button>
    </div>

    <!-- Lender Panel -->
    <div id="lenderPanel" class="panel">
      <h4>ðŸ’° Offer Loan</h4>
      <input id="loanAmount" type="number" placeholder="Loan Amount (ETH)" class="form-control mb-2">
      <input id="interestRate" type="number" placeholder="Interest Rate (%)" class="form-control mb-2">
      <input id="lenderDoc" type="file" class="form-control mb-3">
      <button class="btn btn-success w-100" onclick="offerLoan()">Offer Loan</button>
    </div>

    <!-- Borrower Panel -->
    <div id="borrowerPanel" class="panel">
      <h4>ðŸ“„ Borrower Actions</h4>
      <input id="borrowerDoc" type="file" class="form-control mb-2">
      <button class="btn btn-secondary w-100 mb-2" onclick="submitDocument()">Submit Document</button>
      <button class="btn btn-warning w-100 mb-2" onclick="takeLoan()">Take Loan</button>
      <button class="btn btn-danger w-100" onclick="repayLoan()">Repay Loan</button>
      <p id="repayStatus" class="mt-2 text-success fw-bold"></p>
    </div>

    <!-- Reset (only for lender) -->
    <div id="resetSection" class="mt-3 panel">
      <button class="btn btn-outline-danger w-100" onclick="resetLoanManually()">ðŸ”„ Reset Loan</button>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toastBox"></div>

  <!-- History Modal -->
  <div id="historyModal" class="history-modal" onclick="closeModal(event)">
    <div class="history-content">
      <h4>Transaction History</h4>
      <ul id="historyList" class="text-start"></ul>
      <button class="btn btn-secondary mt-3" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    let currentPanel = null;

    // Show Panel
    function showPanel(type) {
      document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('show');
        setTimeout(() => { if (!panel.classList.contains('show')) panel.style.display = 'none'; }, 300);
      });

      document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));

      setTimeout(() => {
        const panel = document.getElementById(type + 'Panel');
        const btn = document.getElementById(type + 'Btn');
        if (panel && btn) {
          panel.style.display = 'block';
          setTimeout(() => panel.classList.add('show'), 50);
          btn.classList.add('active');
          currentPanel = type;
          const resetSection = document.getElementById('resetSection');
          if (type === 'lender') resetSection.classList.add('show');
          else resetSection.classList.remove('show');
        }
      }, 300);
    }

    // Dark Mode
    function toggleDarkMode() { document.body.classList.toggle("dark-mode"); }

    // Toast
    function showToast(message, type="info") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = message;
      toast.style.background = type === "success" ? "green" : type === "error" ? "red" : "orange";
      document.getElementById("toastBox").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Blockchain
    let web3, account;
    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanStartTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
    let contract;

    // Connect Wallet
    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
          account = accounts[0];
          contract = new web3.eth.Contract(contractABI, contractAddress);
          document.getElementById("walletAddress").style.display = "block";
          document.getElementById("walletAddress").innerText = "Connected: " + account;
          showToast("Wallet connected", "success");
        } catch { showToast("Wallet connection failed", "error"); }
      } else showToast("MetaMask not found!", "error");
    }

    // File Hash
    async function getFileHash(file) {
      const arrayBuffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
      return "0x" + Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    // Loan Functions
    async function offerLoan() {
      const rate = document.getElementById("interestRate").value;
      const amount = document.getElementById("loanAmount").value;
      const file = document.getElementById("lenderDoc").files[0];
      if (!rate || !amount || !file) return showToast("Fill all fields","error");
      const docHash = await getFileHash(file);
      try {
        await contract.methods.offerLoan(rate, docHash).send({ from: account, value: web3.utils.toWei(amount,"ether") });
        showToast("Loan offered!","success"); addHistory("Lender offered "+amount+" ETH @"+rate+"%");
      } catch { showToast("Offer failed","error"); }
    }

    async function submitDocument() {
      const file = document.getElementById("borrowerDoc").files[0];
      if (!file) return showToast("Upload file first","error");
      const docHash = await getFileHash(file);
      try {
        await contract.methods.submitDocument(docHash).send({ from: account });
        showToast("Document submitted!","success"); addHistory("Borrower submitted document");
      } catch { showToast("Submission failed","error"); }
    }

    async function takeLoan() {
      try { await contract.methods.takeLoan().send({ from: account });
        showToast("Loan taken!","success"); addHistory("Borrower took loan");
      } catch { showToast("Take loan failed","error"); }
    }

    async function repayLoan() {
      try {
        const loanAmount = await contract.methods.loanAmount().call();
        const rate = await contract.methods.interestRate().call();
        const repayment = BigInt(loanAmount) + (BigInt(loanAmount)*BigInt(rate)/BigInt(100));
        await contract.methods.repayLoan().send({ from: account, value: repayment.toString() });
        showToast("Loan repaid!","success");
        document.getElementById("repayStatus").innerText="Loan repaid successfully.";
        addHistory("Borrower repaid loan");
      } catch { showToast("Repayment failed","error"); }
    }

    async function resetLoanManually() {
      try { await contract.methods.resetLoan().send({ from: account });
        showToast("Loan reset!","success"); addHistory("Loan reset");
      } catch { showToast("Reset failed","error"); }
    }

    // History
    function addHistory(entry) {
      const li=document.createElement("li");
      li.textContent=entry+" ("+new Date().toLocaleString()+")";
      document.getElementById("historyList").appendChild(li);
    }
    function showHistoryModal(){document.getElementById("historyModal").style.display="flex";}
    function closeModal(event){if(!event || event.target===document.getElementById("historyModal")) document.getElementById("historyModal").style.display="none";}
  </script>
</body>
</html>
