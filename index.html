<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document-backed P2P Lending</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">ðŸ“„ Document-backed P2P Lending</h1>

    <button id="connectWallet" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">Connect Wallet</button>
    <p id="walletAddress" class="mb-6 text-sm"></p>

    <!-- LENDER SECTION -->
    <div class="bg-white p-6 rounded shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Lender Panel</h2>
      <input type="number" id="interestRate" class="border p-2 w-full mb-3" placeholder="Interest Rate (%)" />
      <input type="file" id="lenderDoc" class="mb-3 w-full" />
      <input type="number" id="loanAmount" class="border p-2 w-full mb-3" placeholder="Loan Amount in ETH" />
      <button id="offerLoan" class="bg-green-600 text-white px-4 py-2 rounded">Offer Loan</button>
    </div>

    <!-- BORROWER SECTION -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">Borrower Panel</h2>
      <input type="text" id="phoneNumber" class="border p-2 w-full mb-3" placeholder="Enter Phone Number" />
      <div id="recaptcha-container" class="mb-3"></div>
      <button id="sendOtp" class="bg-yellow-500 text-white px-4 py-2 rounded">Send OTP</button>

      <input type="text" id="otp" class="border p-2 w-full my-3" placeholder="Enter OTP" />
      <input type="file" id="borrowerDoc" class="mb-3 w-full" />
      <button id="verifyOtpSubmitDoc" class="bg-blue-600 text-white px-4 py-2 rounded">Verify & Submit Document</button>

      <button id="takeLoan" class="bg-purple-600 text-white px-4 py-2 mt-4 rounded">Take Loan</button>
      <button id="repayLoan" class="bg-red-600 text-white px-4 py-2 mt-2 rounded">Repay Loan</button>
    </div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7E27dTzpP48muPwSt-hVSNvPai5SHryU",
      authDomain: "p2plending-c864a.firebaseapp.com",
      projectId: "p2plending-c864a",
      storageBucket: "p2plending-c864a.firebasestorage.app",
      messagingSenderId: "916198463762",
      appId: "1:916198463762:web:de2cf6383ff18d456dbbcb",
      measurementId: "G-SHSBBCS0W7"
    };
    firebase.initializeApp(firebaseConfig);

    let web3, contract;
    const contractAddress = "0x608578ad799148D5009D66800BA4EB3eD361943D";
    const abi = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_interestRate",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "_docHash",
				"type": "bytes32"
			}
		],
		"name": "offerLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "repayLoan",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resetLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_userDocHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "_phone",
				"type": "string"
			}
		],
		"name": "submitDocument",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "takeLoan",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "borrower",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "borrowerPhone",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "docSubmitted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "documentHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "interestRate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lender",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanAmount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanOffered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanRepaid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "loanTaken",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    document.getElementById("connectWallet").onclick = async () => {
      if (window.ethereum) {
        try {
          await ethereum.request({ method: "eth_requestAccounts" });
          web3 = new Web3(window.ethereum);
          const accounts = await web3.eth.getAccounts();
          document.getElementById("walletAddress").innerText = `Connected: ${accounts[0]}`;
          contract = new web3.eth.Contract(abi, contractAddress);
        } catch (err) {
          alert("Connection failed");
        }
      } else {
        alert("MetaMask not found!");
      }
    };

    // Lender offers loan
    document.getElementById("offerLoan").onclick = async () => {
      const rate = document.getElementById("interestRate").value;
      const file = document.getElementById("lenderDoc").files[0];
      const amount = document.getElementById("loanAmount").value;
      if (!file || !rate || !amount) return alert("All fields are required");
      const reader = new FileReader();
      reader.onload = async function(e) {
        const hash = CryptoJS.SHA256(CryptoJS.enc.Latin1.parse(e.target.result)).toString();
        const accounts = await web3.eth.getAccounts();
        await contract.methods.offerLoan(rate, hash).send({ from: accounts[0], value: web3.utils.toWei(amount, 'ether') });
        alert("Loan offered successfully");
      };
      reader.readAsBinaryString(file);
    };

    // Firebase OTP
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container');
    document.getElementById("sendOtp").onclick = () => {
      const phone = document.getElementById("phoneNumber").value;
      if (!phone) return alert("Enter phone number");
      firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier)
        .then(conf => window.confirmationResult = conf)
        .catch(e => alert(e.message));
    };

    // Borrower OTP verify + document submit
    document.getElementById("verifyOtpSubmitDoc").onclick = async () => {
      const code = document.getElementById("otp").value;
      const file = document.getElementById("borrowerDoc").files[0];
      const phone = document.getElementById("phoneNumber").value;
      if (!file || !code || !phone) return alert("Fill all fields");
      const result = await window.confirmationResult.confirm(code);
      const reader = new FileReader();
      reader.onload = async function(e) {
        const hash = CryptoJS.SHA256(CryptoJS.enc.Latin1.parse(e.target.result)).toString();
        const accounts = await web3.eth.getAccounts();
        await contract.methods.submitDocument(hash, phone).send({ from: accounts[0] });
        alert("Document submitted successfully");
      };
      reader.readAsBinaryString(file);
    };

    // Borrower take loan
    document.getElementById("takeLoan").onclick = async () => {
      const accounts = await web3.eth.getAccounts();
      await contract.methods.takeLoan().send({ from: accounts[0] });
      alert("Loan taken successfully");
    };

    // Repay loan
    document.getElementById("repayLoan").onclick = async () => {
      const accounts = await web3.eth.getAccounts();
      const loanAmt = await contract.methods.loanAmount().call();
      const interest = await contract.methods.interestRate().call();
      const total = loanAmt * (1 + interest / 100);
      await contract.methods.repayLoan().send({ from: accounts[0], value: total });
      alert("Loan repaid with interest");
    };
  </script>
</body>
</html>
